<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <!-- Bootstrap CSS CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      display: flex;
      min-height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      width: 220px;
      background: #343a40;
      color: white;
      display: flex;
      flex-direction: column;
    }
    #sidebar .sidebar-link {
      padding: 1rem 1.25rem;
      cursor: pointer;
      color: white;
      text-decoration: none;
      border-bottom: 1px solid #495057;
      user-select: none;
    }
    #sidebar .sidebar-link.active,
    #sidebar .sidebar-link:hover {
      background: #495057;
    }
    #content-area {
      flex: 1;
      padding: 1rem 2rem;
      overflow-y: auto;
    }
    .filters {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .filter-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
  </style>
</head>
<body>
  <nav id="sidebar" class="d-flex flex-column">
    <a class="sidebar-link active" data-section="students">Students</a>
    <a class="sidebar-link" data-section="filieres">Filieres</a>
    <a class="sidebar-link" data-section="sections">Sections</a>
    <a class="sidebar-link" data-section="groupes">Groupes</a>
  </nav>

  <main id="content-area">
    <div id="content-wrapper">
      <!-- Dynamic content loads here -->
    </div>
  </main>

  <!-- Toast Notification -->
  <div
    id="liveToast"
    class="toast align-items-center text-bg-success border-0 position-fixed bottom-0 end-0 m-3"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
    style="z-index: 1100"
  >
    <div class="d-flex">
      <div id="toastMsg" class="toast-body"></div>
      <button
        type="button"
        class="btn-close btn-close-white me-2 m-auto"
        data-bs-dismiss="toast"
        aria-label="Close"
      ></button>
    </div>
  </div>

  <!-- Modal for Add/Edit -->
  <div
    class="modal fade"
    id="crudModal"
    tabindex="-1"
    aria-labelledby="crudModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form id="crudForm" class="modal-content" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="crudModalLabel">Modal title</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- Dynamic form inputs go here -->
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS Bundle CDN (includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = "http://localhost/ens-gestion/api/admin.php";
    const toastEl = new bootstrap.Toast(document.getElementById("liveToast"));
    let currentFilters = {
      field_id: '',
      section_id: '',
      group_id: '',
      annee_id: ''
    };

    function showToast(msg, ok = true) {
      const toastMsg = document.getElementById("toastMsg");
      toastMsg.textContent = msg;
      const toastParent = document.getElementById("liveToast");
      toastParent.classList.toggle("text-bg-success", ok);
      toastParent.classList.toggle("text-bg-danger", !ok);
      toastEl.show();
    }

    // Sidebar navigation
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".sidebar-link").forEach(link => {
        link.addEventListener("click", () => switchSection(link));
      });
      loadStudents(); // Initial load
    });

    function switchSection(link) {
      document.querySelectorAll(".sidebar-link").forEach(l => l.classList.remove("active"));
      link.classList.add("active");
      const section = link.dataset.section;
      const content = document.getElementById("content-wrapper");
      content.innerHTML = "<p>Loading...</p>";

      switch (section) {
        case "students":
          loadStudents();
          break;
        case "filieres":
          loadFilieres();
          break;
        case "sections":
          loadSections();
          break;
        case "groupes":
          loadGroupes();
          break;
      }
    }

    /* ==================== STUDENT SECTION ==================== */
    async function loadStudents() {
      try {
        // Build URL with filters
        const params = new URLSearchParams();
        if (currentFilters.field_id) params.append('field_id', currentFilters.field_id);
        if (currentFilters.section_id) params.append('section_id', currentFilters.section_id);
        if (currentFilters.group_id) params.append('group_id', currentFilters.group_id);
        if (currentFilters.annee_id) params.append('annee_id', currentFilters.annee_id);

        const res = await fetch(`${API_BASE}?action=getStudents&${params.toString()}`, { credentials: "include" });
        const data = await res.json();

        if (!document.querySelector('.filters')) {
          renderStudentFilters();
        }

        setupTable({
          title: `Students (${data.count})`,
          head: ["ID", "Nom", "Prenom", "Email", "Actions"],
          rows: data.students.map(s => [
            s.user_id,
            s.nom,
            s.prenom,
            s.email,
            actionButtons(() => openStudentModal("edit", s), () => deleteStudent(s.user_id))
          ]),
          onAdd: () => openStudentModal("add")
        });

      } catch (e) {
        showToast("Failed to load students: " + e.message, false);
      }
    }

    // Render filters UI for students
    async function renderStudentFilters() {
      const content = document.getElementById("content-wrapper");
      const filterHtml = `
        <div class="filters">
          <h5>Filters</h5>
          <div class="filter-row">
            <div class="filter-group">
              <label class="form-label">Filiere</label>
              <select class="form-select" id="fieldFilter">
                <option value="">All Filieres</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="form-label">Section</label>
              <select class="form-select" id="sectionFilter">
                <option value="">All Sections</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="form-label">Groupe</label>
              <select class="form-select" id="groupFilter">
                <option value="">All Groupes</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="form-label">Year</label>
              <select class="form-select" id="yearFilter">
                <option value="">All Years</option>
              </select>
            </div>
            <div class="filter-group d-flex align-items-center">
              <button class="btn btn-secondary" id="resetFilters">Reset</button>
            </div>
          </div>
        </div>
      `;
      content.insertAdjacentHTML('afterbegin', filterHtml);

      await loadFilterOptions();
      setupFilterEvents();
    }

    // Load options for filters
    async function loadFilterOptions() {
      try {
        // Filieres
        const filieresRes = await fetch(`${API_BASE}?action=getFilieres`, { credentials: "include" });
        const filieresData = await filieresRes.json();
        const fieldSelect = document.getElementById('fieldFilter');
        filieresData.data.forEach(f => {
          const option = document.createElement("option");
          option.value = f.field_id;
          option.textContent = f.nom;
          fieldSelect.appendChild(option);
        });

        // Years
        const yearsRes = await fetch(`${API_BASE}?action=getAllyears`, { credentials: "include" });
        const yearsData = await yearsRes.json();
        const years = yearsData.data?.data || [];
        const yearSelect = document.getElementById('yearFilter');
        years.forEach(y => {
          const option = document.createElement("option");
          option.value = y.annee_id;
          option.textContent = y.annee_id + (y.current_flag == 1 ? ' (current)' : '');
          yearSelect.appendChild(option);
        });
      } catch (e) {
        console.error("Error loading filters:", e);
      }
    }

    // Setup events on filter controls
    function setupFilterEvents() {
      document.getElementById('fieldFilter').addEventListener('change', async (e) => {
        currentFilters.field_id = e.target.value;
        currentFilters.section_id = '';
        currentFilters.group_id = '';

        const sectionSelect = document.getElementById('sectionFilter');
        sectionSelect.innerHTML = '<option value="">All Sections</option>';

        if (e.target.value) {
          try {
            const res = await fetch(`${API_BASE}?action=getSectionsByFiliere&field_id=${e.target.value}`, { 
              credentials: "include" 
            });
            const json = await res.json();
            const sections = json.data || [];
            sections.forEach(s => {
              const option = document.createElement("option");
              option.value = s.section_id;
              option.textContent = s.nom;
              sectionSelect.appendChild(option);
            });
          } catch (e) {
            console.error("Error loading sections:", e);
          }
        }
        loadStudents();
      });

      document.getElementById('sectionFilter').addEventListener('change', async (e) => {
        currentFilters.section_id = e.target.value;
        currentFilters.group_id = '';

        const groupSelect = document.getElementById('groupFilter');
        groupSelect.innerHTML = '<option value="">All Groupes</option>';

        if (e.target.value) {
          try {
            const res = await fetch(`${API_BASE}?action=getGroupesBySection&section_id=${e.target.value}`, { credentials: "include" });
            const groupes = await res.json();
            groupes.forEach(g => {
              const option = document.createElement("option");
              option.value = g.group_id;
              option.textContent = g.nom;
              groupSelect.appendChild(option);
            });
          } catch (e) {
            console.error("Error loading groupes:", e);
          }
        }
        loadStudents();
      });

      document.getElementById('groupFilter').addEventListener('change', (e) => {
        currentFilters.group_id = e.target.value;
        loadStudents();
      });

      document.getElementById('yearFilter').addEventListener('change', (e) => {
        currentFilters.annee_id = e.target.value;
        loadStudents();
      });

      document.getElementById('resetFilters').addEventListener('click', () => {
        currentFilters = { field_id: '', section_id: '', group_id: '', annee_id: '' };
        document.getElementById('fieldFilter').value = '';
        document.getElementById('sectionFilter').innerHTML = '<option value="">All Sections</option>';
        document.getElementById('sectionFilter').value = '';
        document.getElementById('groupFilter').innerHTML = '<option value="">All Groupes</option>';
        document.getElementById('groupFilter').value = '';
        document.getElementById('yearFilter').value = '';
        loadStudents();
      });
    }

    // Setup table with title, header, rows and Add button callback
    function setupTable({title, head, rows, onAdd}) {
      const content = document.getElementById("content-wrapper");
      // Clear except filters
      const filters = content.querySelector('.filters');
      content.innerHTML = '';
      if (filters) content.appendChild(filters);

      // Create header + add button area
      const headerDiv = document.createElement("div");
      headerDiv.className = "d-flex justify-content-between align-items-center mb-3";
      const h2 = document.createElement("h2");
      h2.textContent = title;
      const addBtn = document.createElement("button");
      addBtn.className = "btn btn-primary";
      addBtn.textContent = "Add";
      addBtn.onclick = onAdd;
      headerDiv.appendChild(h2);
      headerDiv.appendChild(addBtn);

      // Create table
      const table = document.createElement("table");
      table.className = "table table-striped align-middle";
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");

      // Table head
      const trHead = document.createElement("tr");
      head.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      // Table rows
      rows.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          if (typeof cell === "string" || typeof cell === "number") {
            td.textContent = cell;
          } else {
            td.appendChild(cell);
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);

      content.appendChild(headerDiv);
      content.appendChild(table);
    }

    // Create action buttons (Edit/Delete) with callbacks
    function actionButtons(onEdit, onDelete) {
      const container = document.createElement("div");
      container.className = "btn-group";

      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-sm btn-warning";
      editBtn.textContent = "Edit";
      editBtn.onclick = onEdit;
      container.appendChild(editBtn);

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-danger";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => {
        if (confirm("Are you sure you want to delete this item?")) {
          onDelete();
        }
      };
      container.appendChild(delBtn);

      return container;
    }

    /* ==================== CRUD Functions ==================== */

    // Delete student by id
    async function deleteStudent(id) {
      try {
        const res = await fetch(`${API_BASE}?action=deleteStudent&user_id=${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const data = await res.json();
        if (data.success) {
          showToast("Student deleted successfully.");
          loadStudents();
        } else {
          showToast("Failed to delete student: " + (data.message || "Unknown error"), false);
        }
      } catch (e) {
        showToast("Error deleting student: " + e.message, false);
      }
    }

    // Open modal for add or edit student
    function openStudentModal(mode, student = null) {
      const modalEl = document.getElementById("crudModal");
      const modalTitle = modalEl.querySelector(".modal-title");
      const modalBody = modalEl.querySelector(".modal-body");
      const form = document.getElementById("crudForm");

      modalTitle.textContent = mode === "add" ? "Add Student" : "Edit Student";

      // Clear modal body and set fields
      modalBody.innerHTML = `
        <div class="mb-3">
          <label for="nom" class="form-label">Nom</label>
          <input type="text" class="form-control" id="nom" name="nom" required />
        </div>
        <div class="mb-3">
          <label for="prenom" class="form-label">Prenom</label>
          <input type="text" class="form-control" id="prenom" name="prenom" required />
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email" name="email" required />
        </div>
      `;

      if (mode === "edit" && student) {
        form.dataset.editId = student.user_id;
        form.nom.value = student.nom;
        form.prenom.value = student.prenom;
        form.email.value = student.email;
      } else {
        delete form.dataset.editId;
        form.reset();
      }

      // Remove old submit handlers
      form.onsubmit = async (e) => {
        e.preventDefault();

        const formData = {
          nom: form.nom.value.trim(),
          prenom: form.prenom.value.trim(),
          email: form.email.value.trim(),
        };

        try {
          let url = `${API_BASE}?action=${mode === "add" ? "addStudent" : "editStudent"}`;
          let method = mode === "add" ? "POST" : "PUT";

          if (mode === "edit") {
            url += `&user_id=${form.dataset.editId}`;
          }

          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
            credentials: "include"
          });

          const data = await res.json();

          if (data.success) {
            showToast(`Student ${mode === "add" ? "added" : "updated"} successfully.`);
            bootstrap.Modal.getInstance(modalEl).hide();
            loadStudents();
          } else {
            showToast("Failed to save student: " + (data.message || "Unknown error"), false);
          }
        } catch (err) {
          showToast("Error saving student: " + err.message, false);
        }
      };

      // Show modal
      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();
    }

    /* ==================== FILIERES SECTION ==================== */
    async function loadFilieres() {
      try {
        const res = await fetch(`${API_BASE}?action=getFilieres`, { credentials: "include" });
        const data = await res.json();

        setupTable({
          title: `Filieres (${data.count || data.data.length})`,
          head: ["ID", "Nom", "Actions"],
          rows: data.data.map(f => [
            f.field_id,
            f.nom,
            actionButtons(() => openFiliereModal("edit", f), () => deleteFiliere(f.field_id))
          ]),
          onAdd: () => openFiliereModal("add")
        });
      } catch (e) {
        showToast("Failed to load filieres: " + e.message, false);
      }
    }

    async function deleteFiliere(id) {
      try {
        const res = await fetch(`${API_BASE}?action=deleteFiliere&field_id=${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const data = await res.json();
        if (data.success) {
          showToast("Filiere deleted successfully.");
          loadFilieres();
        } else {
          showToast("Failed to delete filiere: " + (data.message || "Unknown error"), false);
        }
      } catch (e) {
        showToast("Error deleting filiere: " + e.message, false);
      }
    }

    function openFiliereModal(mode, filiere = null) {
      const modalEl = document.getElementById("crudModal");
      const modalTitle = modalEl.querySelector(".modal-title");
      const modalBody = modalEl.querySelector(".modal-body");
      const form = document.getElementById("crudForm");

      modalTitle.textContent = mode === "add" ? "Add Filiere" : "Edit Filiere";

      modalBody.innerHTML = `
        <div class="mb-3">
          <label for="nom" class="form-label">Nom</label>
          <input type="text" class="form-control" id="nom" name="nom" required />
        </div>
      `;

      if (mode === "edit" && filiere) {
        form.dataset.editId = filiere.field_id;
        form.nom.value = filiere.nom;
      } else {
        delete form.dataset.editId;
        form.reset();
      }

      form.onsubmit = async (e) => {
        e.preventDefault();

        const formData = { nom: form.nom.value.trim() };

        try {
          let url = `${API_BASE}?action=${mode === "add" ? "addFiliere" : "editFiliere"}`;
          let method = mode === "add" ? "POST" : "PUT";

          if (mode === "edit") {
            url += `&field_id=${form.dataset.editId}`;
          }

          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
            credentials: "include"
          });

          const data = await res.json();

          if (data.success) {
            showToast(`Filiere ${mode === "add" ? "added" : "updated"} successfully.`);
            bootstrap.Modal.getInstance(modalEl).hide();
            loadFilieres();
          } else {
            showToast("Failed to save filiere: " + (data.message || "Unknown error"), false);
          }
        } catch (err) {
          showToast("Error saving filiere: " + err.message, false);
        }
      };

      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();
    }

    /* ==================== SECTIONS SECTION ==================== */
    async function loadSections() {
      try {
        const res = await fetch(`${API_BASE}?action=getSections`, { credentials: "include" });
        const data = await res.json();

        setupTable({
          title: `Sections (${data.count || data.data.length})`,
          head: ["ID", "Nom", "Actions"],
          rows: data.data.map(s => [
            s.section_id,
            s.nom,
            actionButtons(() => openSectionModal("edit", s), () => deleteSection(s.section_id))
          ]),
          onAdd: () => openSectionModal("add")
        });
      } catch (e) {
        showToast("Failed to load sections: " + e.message, false);
      }
    }

    async function deleteSection(id) {
      try {
        const res = await fetch(`${API_BASE}?action=deleteSection&section_id=${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const data = await res.json();
        if (data.success) {
          showToast("Section deleted successfully.");
          loadSections();
        } else {
          showToast("Failed to delete section: " + (data.message || "Unknown error"), false);
        }
      } catch (e) {
        showToast("Error deleting section: " + e.message, false);
      }
    }

    function openSectionModal(mode, section = null) {
      const modalEl = document.getElementById("crudModal");
      const modalTitle = modalEl.querySelector(".modal-title");
      const modalBody = modalEl.querySelector(".modal-body");
      const form = document.getElementById("crudForm");

      modalTitle.textContent = mode === "add" ? "Add Section" : "Edit Section";

      modalBody.innerHTML = `
        <div class="mb-3">
          <label for="nom" class="form-label">Nom</label>
          <input type="text" class="form-control" id="nom" name="nom" required />
        </div>
      `;

      if (mode === "edit" && section) {
        form.dataset.editId = section.section_id;
        form.nom.value = section.nom;
      } else {
        delete form.dataset.editId;
        form.reset();
      }

      form.onsubmit = async (e) => {
        e.preventDefault();

        const formData = { nom: form.nom.value.trim() };

        try {
          let url = `${API_BASE}?action=${mode === "add" ? "addSection" : "editSection"}`;
          let method = mode === "add" ? "POST" : "PUT";

          if (mode === "edit") {
            url += `&section_id=${form.dataset.editId}`;
          }

          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
            credentials: "include"
          });

          const data = await res.json();

          if (data.success) {
            showToast(`Section ${mode === "add" ? "added" : "updated"} successfully.`);
            bootstrap.Modal.getInstance(modalEl).hide();
            loadSections();
          } else {
            showToast("Failed to save section: " + (data.message || "Unknown error"), false);
          }
        } catch (err) {
          showToast("Error saving section: " + err.message, false);
        }
      };

      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();
    }

    /* ==================== GROUPES SECTION ==================== */
    async function loadGroupes() {
      try {
        const res = await fetch(`${API_BASE}?action=getGroupes`, { credentials: "include" });
        const data = await res.json();

        setupTable({
          title: `Groupes (${data.count || data.data.length})`,
          head: ["ID", "Nom", "Actions"],
          rows: data.data.map(g => [
            g.group_id,
            g.nom,
            actionButtons(() => openGroupeModal("edit", g), () => deleteGroupe(g.group_id))
          ]),
          onAdd: () => openGroupeModal("add")
        });
      } catch (e) {
        showToast("Failed to load groupes: " + e.message, false);
      }
    }

    async function deleteGroupe(id) {
      try {
        const res = await fetch(`${API_BASE}?action=deleteGroupe&group_id=${id}`, {
          method: "DELETE",
          credentials: "include"
        });
        const data = await res.json();
        if (data.success) {
          showToast("Groupe deleted successfully.");
          loadGroupes();
        } else {
          showToast("Failed to delete groupe: " + (data.message || "Unknown error"), false);
        }
      } catch (e) {
        showToast("Error deleting groupe: " + e.message, false);
      }
    }

    function openGroupeModal(mode, groupe = null) {
      const modalEl = document.getElementById("crudModal");
      const modalTitle = modalEl.querySelector(".modal-title");
      const modalBody = modalEl.querySelector(".modal-body");
      const form = document.getElementById("crudForm");

      modalTitle.textContent = mode === "add" ? "Add Groupe" : "Edit Groupe";

      modalBody.innerHTML = `
        <div class="mb-3">
          <label for="nom" class="form-label">Nom</label>
          <input type="text" class="form-control" id="nom" name="nom" required />
        </div>
      `;

      if (mode === "edit" && groupe) {
        form.dataset.editId = groupe.group_id;
        form.nom.value = groupe.nom;
      } else {
        delete form.dataset.editId;
        form.reset();
      }

      form.onsubmit = async (e) => {
        e.preventDefault();

        const formData = { nom: form.nom.value.trim() };

        try {
          let url = `${API_BASE}?action=${mode === "add" ? "addGroupe" : "editGroupe"}`;
          let method = mode === "add" ? "POST" : "PUT";

          if (mode === "edit") {
            url += `&group_id=${form.dataset.editId}`;
          }

          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
            credentials: "include"
          });

          const data = await res.json();

          if (data.success) {
            showToast(`Groupe ${mode === "add" ? "added" : "updated"} successfully.`);
            bootstrap.Modal.getInstance(modalEl).hide();
            loadGroupes();
          } else {
            showToast("Failed to save groupe: " + (data.message || "Unknown error"), false);
          }
        } catch (err) {
          showToast("Error saving groupe: " + err.message, false);
        }
      };

      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();
    }
  </script>
</body>
</html>
