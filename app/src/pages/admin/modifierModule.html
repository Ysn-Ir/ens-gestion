<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - Modifier un Module</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .sidebar {
      height: 100vh;
      width: 220px;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #343a40;
      padding-top: 60px;
      color: #fff;
    }

    .sidebar h4 {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #495057;
    }

    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #adb5bd;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }

    .sidebar a:hover {
      background-color: #495057;
      color: #ffffff;
    }

    .content {
      margin-left: 240px;
      padding: 30px;
      background-color: #ffffff;
      min-height: 100vh;
    }

    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
    }

    .form-section {
      background-color: #f1f1f1;
      padding: 20px;
      border-radius: 10px;
      border: 1px solid #ced4da;
    }

    .dynamic-section {
      border: 1px solid #ced4da;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #ffffff;
    }
  </style>
</head>
<body>
  <button id="logoutBtn" class="btn btn-danger logout-btn">Déconnexion</button>

  <div class="sidebar">
    <h4>Menu</h4>
    <a href="etudiants.html">Étudiants</a>
    <a href="professeurs.html">Professeurs</a>
    <a href="depart.html">Départements</a>
    <a href="filieres.html">Filières</a>
    <a href="modules.html">Modules</a>
    <a href="notes.html">Notes</a>
    <a href="parametres.html">Paramètres</a>
  </div>

  <div class="content">
    <div class="welcome-message mb-4">
      Bonjour <span id="usernameDisplay"></span> !
    </div>
    <div class="alert alert-info">
      Vous êtes connecté en tant que: <strong id="userRole"></strong>
    </div>
    <div class="d-flex justify-content-between mb-3">
          
          <div class="p-2 ">     
            <button type="button" class="btn btn-dark" onclick="retourner()"> Retourner à la liste des modules</button>
      </div>
        </div>

    <div class="form-section">
      <h2 class="mb-4">Modifier un Module</h2>
      <form id="moduleForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="code_module" class="form-label">Code Module</label>
            <input type="text" class="form-control" id="code_module" required>
          </div>
          <div class="col-md-6 mb-3">
            <label for="nom_module" class="form-label">Nom Module</label>
            <input type="text" class="form-control" id="nom_module" required>
          </div>
        </div>

        <h4 class="mt-4">Éléments de Module</h4>
        <div class="col-md-4 mb-3">
                <label><h6 class=" mb-3">Le module est-il composé d’éléments ?</h6></label>
                <select class="form-select  mb-3" id="hasElement" required>
                    <option value="">-- Sélectionner --</option>
                    <option value="Non">Non</option>
                    <option value="Oui">Oui</option>
                </select>
        </div>

        





        <div id="elementsContainer"></div>
        <div id="elementControls"></div>
        <div id="elementList"></div>
        <!-- <button type="button" class="btn btn-outline-primary mb-3" onclick="addElement()">Ajouter Élément</button> --> 

        <h4 class="mt-4">Filière Associée</h4>
        <div id="filieresContainer">
          <div class="row">
        <div class="col-md-6 mb-3">
          <label>Filière</label>
          <select class="form-select" id="filiere" required>
              <option disabled selected>Choisissez une filière</option>
            </select>
        </div>
        <div class="col-md-6 mb-3">
          <label>Semestre</label>
          <select class="form-select" id="semestre" required>
                          <option disabled selected>Choisissez le semestre</option>

          </select>
        </div>
       
      </div>
        </div>
        <div >
        <button type="submit" class="btn btn-dark mb-">Enregistrer les modifications</button>

        </div>
      </form>
    </div>
  </div>

 <script>
document.addEventListener('DOMContentLoaded', function () {
  const filiereSelect = document.getElementById('filiere');
  const elementsContainer = document.getElementById("elementsContainer");
  const elementControls = document.getElementById("elementControls");
  const hasElement = document.getElementById("hasElement");

  let elementIndex = 0;
  let allProfs = [];

  // Charger les filières
  fetch('http://localhost:8080/ens-gestion/api/admin2.php?action=getFilieres', {
    method: 'GET',
    credentials: 'include'
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success" && Array.isArray(data.data)) {
      data.data.forEach(filiere => {
        const option = document.createElement('option');
        option.value = filiere.field_id;
        option.textContent = filiere.nom_filiere ?? filiere.nom ?? "Nom inconnu";
        filiereSelect.appendChild(option);
      });
    } else {
      const option = document.createElement('option');
      option.textContent = "Aucune filière disponible";
      option.disabled = true;
      filiereSelect.appendChild(option);
    }
  })
  .catch(error => {
    console.error("Erreur lors du chargement des filières :", error);
    filiereSelect.innerHTML = '';
    const option = document.createElement('option');
    option.textContent = "Erreur de chargement";
    option.disabled = true;
    filiereSelect.appendChild(option);
  });

  // // Charger les professeurs une seule fois au démarrage
  // fetch('http://localhost:8080/ens-gestion/api/admin2.php?action=GetAllProffessors')
  // .then(res => res.json())
  // .then(data => {
  //   for (const key in data) {
  //     if (!isNaN(key)) {
  //       allProfs.push(data[key]);
  //     }
  //   }

  //   loadLocalData();
  // })
  // .catch(error => {
  //   console.error(error);
  //   alert("Erreur lors du chargement des professeurs");
  // });

  //Charger Prof
                      fetch('http://localhost:8080/ens-gestion/api/admin2.php?action=GetAllProffessors')
                      .then(res => res.json())
                      .then(data => {
                        if (data.status === "success") {
                          allProfs.push(...data.data); // Ajoute tous les professeurs à ton tableau
                              loadLocalData();

                        } else {
                          alert("Erreur: " + data.message);
                        }
                      })
                      .catch(error => {
                        console.error(error);
                        alert("Erreur lors du chargement des professeurs");
                      });


  // Quand la sélection "hasElement" change
  hasElement.addEventListener("change", function () {
    elementsContainer.innerHTML = "";
    elementControls.innerHTML = "";
    elementIndex = 0;

    if (hasElement.value === "Oui") {
      addElement(); // ajoute le premier élément

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-outline-primary mb-3";
      btn.innerText = "Ajouter Élément";
      btn.onclick = addElement;

      elementControls.appendChild(btn);

    } else if (hasElement.value === "Non") {
      // Affiche les coefficients simples + selects prof_element et prof_tp pour le module seul
      elementsContainer.innerHTML = `
        <h4>Entrez les coefficients de module</h4>
        <div class="row">
          <div class="col-md-2 mb-3">
            <label>Coeff Écrit</label>
            <input type="number" class="form-control" min="0" max="1" step="0.01" id="module_ecrit" required>
          </div>
          <div class="col-md-2 mb-3">
            <label>Coeff CC</label>
            <input type="number" class="form-control" min="0" max="1" step="0.01" id="module_cc" required>
          </div>
          <div class="col-md-2 mb-3">
            <label>Coeff TP</label>
            <input type="number" class="form-control" min="0" max="1" step="0.01" id="module_tp" required>
          </div>
          
          <div class="col-md-3 mb-3">
            <label>Prof Élément</label>
            <select class="form-select" id="prof_element" required>
              <option disabled selected value="">Choisissez le prof de l'élément</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label>Prof TP</label>
            <select class="form-select" id="prof_tp" required>
              <option value="null" selected>Aucun professeur</option>
            </select>
          </div>
        </div>
      `;

      // Remplir selects prof_element et prof_tp pour le module seul
      const profElementSelect = document.getElementById("prof_element");
      const profTPSelect = document.getElementById("prof_tp");

      allProfs.forEach(prof => {
        const option1 = document.createElement('option');
        option1.value = prof.user_id;
        option1.textContent = `${prof.nom} ${prof.prenom}`;
        profElementSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = prof.user_id;
        option2.textContent = `${prof.nom} ${prof.prenom}`;
        profTPSelect.appendChild(option2);
      });

    } else {
      elementsContainer.innerHTML = "";
      elementControls.innerHTML = "";
    }
  });


  // Chargement données locales + initialisation formulaire
  function loadLocalData() {
    // Remplir les champs code_module et nom_module depuis localStorage
    document.getElementById("code_module").value = localStorage.getItem("code_module") || "";
    document.getElementById("nom_module").value = localStorage.getItem("nom_module") || "";

    // Gestion des éléments selon hasElement
    if (localStorage.getItem("nom_element0") !== "null" && localStorage.getItem("nom_element0") !== null) {
      hasElement.value = "Oui";

      const numberOfElements = parseInt(localStorage.getItem("numberOfElements"), 10) || 0;

      for (let i = 0; i < numberOfElements; i++) {
        // Récupérer prof_element et prof_tp stockés localement (s'ils existent)
        const profEl = localStorage.getItem(`prof_element_${i}`) || null;
        const profTP = localStorage.getItem(`prof_tp_${i}`) || null;

        addElement(profEl, profTP);

        // Remplir les inputs avec les valeurs stockées
        document.getElementById(`element_nom_${i}`).value = localStorage.getItem(`nom_element${i}`) || "";
        document.getElementById(`element_cc_${i}`).value = localStorage.getItem(`cc_${i}`) || "";
        document.getElementById(`element_ecrit_${i}`).value = localStorage.getItem(`ecrit_${i}`) || "";
        document.getElementById(`element_tp_${i}`).value = localStorage.getItem(`tp_${i}`) || "";
        document.getElementById(`element_${i}`).value = localStorage.getItem(`el_${i}`) || "";
      }

      // Ajouter bouton "Ajouter Élément"
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-outline-primary mb-3";
      btn.innerText = "Ajouter Élément";
      btn.onclick = () => addElement();

      elementControls.appendChild(btn);
    }
  }

  // Ajouter un élément dynamique avec selects de profs remplis
  function addElement() {
    const div = document.createElement("div");
    div.className = "dynamic-section";
    div.id = `element_div_${elementIndex}`;  // <-- Ajout de l'id ici

    div.innerHTML = `
      <div class="row">
        <div class="col-md-6 mb-3">
          <label>Nom Élément</label>
          <input type="text" class="form-control" id="element_nom_${elementIndex}" required>
        </div>
        <div class="col-md-2 mb-3">
          <label>Coeff Écrit</label>
          <input type="number" class="form-control" min="0" max="1" step="0.01" id="element_ecrit_${elementIndex}" required>
        </div>
        <div class="col-md-2 mb-3">
          <label>Coeff CC</label>
          <input type="number" class="form-control" min="0" max="1" step="0.01" id="element_cc_${elementIndex}" required>
        </div>
        <div class="col-md-2 mb-3">
          <label>Coeff TP</label>
          <input type="number" class="form-control" min="0" max="1" step="0.01" id="element_tp_${elementIndex}" required>
        </div>
        <div class="col-md-2 mb-3">
          <label>Coeff Élément</label>
          <input type="number" class="form-control" min="0" max="1" step="0.01" id="element_${elementIndex}" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>Prof Élément</label>
          <select class="form-select" id="prof_element_${elementIndex}" required>
            <option disabled selected value="">Choisissez le prof de l'élément</option>
          </select>
        </div>
        <div class="col-md-3 mb-3">
          <label>Prof TP</label>
          <select class="form-select" id="prof_tp_${elementIndex}" required>
            <option value="null" selected>Aucun professeur</option>
          </select>
        </div>


         <div class="col-md-1 mb-3 d-flex align-items-end">
          <button class="btn btn-sm btn-danger" onclick="supprimerElement(${elementIndex})">Supprimer</button>
        </div>
      </div>
    `;

    elementsContainer.appendChild(div);

    // Remplir selects prof_element et prof_tp avec la liste allProfs
    const profElementSelect = document.getElementById(`prof_element_${elementIndex}`);
    const profTPSelect = document.getElementById(`prof_tp_${elementIndex}`);

    allProfs.forEach(prof => {
      const option1 = document.createElement('option');
      option1.value = prof.user_id;
      option1.textContent = `${prof.nom} ${prof.prenom}`;
      profElementSelect.appendChild(option1);

      const option2 = document.createElement('option');
      option2.value = prof.user_id;
      option2.textContent = `${prof.nom} ${prof.prenom}`;
      profTPSelect.appendChild(option2);
    });

    elementIndex++;
  }

  // Gestion du changement de filière pour charger les semestres
  filiereSelect.addEventListener("change", () => {
    const filiereId = filiereSelect.value;
    fetch(`http://localhost:8080/ens-gestion/api/admin2.php?action=getNombreSemestresByFiliere&field_id=${filiereId}`)
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          const nombreSemestre = data.nombre_semestre;
          const semestreSelect = document.getElementById("semestre");
          semestreSelect.innerHTML = ""; // Clear previous
          for (let i = 1; i <= nombreSemestre; i++) {
            const option = document.createElement("option");
            option.value = i;
            option.textContent = "Semestre " + i;
            semestreSelect.appendChild(option);
          }
        }
      })
      .catch(() => alert("Erreur lors du chargement des semestres"));
  });

  // Soumission du formulaire
  document.getElementById("moduleForm").addEventListener("submit", function (e) {
    e.preventDefault();
    ModifierModule();
  });

  function ModifierModule() {
    const code = document.getElementById("code_module").value.trim();
    const nom = document.getElementById("nom_module").value.trim();

    if (!code || !nom) {
      alert("Veuillez remplir le code et le nom du module.");
      return;
    }

    const filiere = filiereSelect.value || null;
    const semestre = document.getElementById("semestre").value || null;

    if (hasElement.value === "Non") {
      // Module sans éléments, récupérer profs selects module seul
      const profElementMain = document.getElementById("prof_element")?.value || null;
      let profTPMain = document.getElementById("prof_tp")?.value;

      if (profTPMain === "null") profTPMain = null;

      const coeff_ecrit = parseFloat(document.getElementById("module_ecrit").value);
      const coeff_cc = parseFloat(document.getElementById("module_cc").value);
      const coeff_tp = parseFloat(document.getElementById("module_tp").value);
      const coeff_element = parseFloat(1);

      if ([coeff_cc, coeff_ecrit, coeff_tp, coeff_element].some(c => isNaN(c) || c < 0 || c > 1)) {
        alert("Tous les coefficients doivent être des nombres valides entre 0 et 1.");
        return;
      }

      const somme = coeff_cc + coeff_ecrit + coeff_tp;
      if (Math.abs(somme - 1) > 0.0001) {
        alert("La somme des coefficients (CC + Écrit + TP) doit être égale à 1.");
        return;
      }

      if (!filiere || !semestre || !profElementMain) {
        alert("Tous les champs sont obligatoires !");
        return;
      }

      const url = `http://localhost:8080/ens-gestion/api/admin2.php?action=UpdateModuleSansElements` +
  `&module_id=${localStorage.getItem("module_id")}` +
  `&nomMod=${encodeURIComponent(nom)}` +
  `&codeMod=${encodeURIComponent(code)}` +
  `&coeff_cc=${coeff_cc}` +
  `&coeff_ecrit=${coeff_ecrit}` +
  `&coeff_element=${coeff_element}` +
  `&coeff_tp=${coeff_tp}` +
  `&filiere=${filiere}` +
  `&semestre=${semestre}` +
  `&prof_element=${profElementMain}` +
  `&prof_tp=${profTPMain !== null ? profTPMain : 'null'}`;

fetch(url, {
  method: "GET",
  credentials: "include",
})
.then(res => res.text())
.then(text => {
  try {
    const result = JSON.parse(text);
    if (result.status === "success") {
      window.location.href = "http://localhost:8080/ens-gestion/app/src/pages/admin/modules.html";
    } else {
      alert("Erreur : " + result.message);
    }
  } catch (e) {
    console.error("Erreur JSON : ", e);
    console.error("Contenu brut : ", text);
    alert("Erreur de réponse serveur : contenu non valide");
  }
})
.catch(err => {
  console.error(err);
  alert("Erreur de communication avec le serveur.");
});


    } else {
      // Module avec éléments

        let elementNoms = [];
        let sommeElement = 0;

        for (let i = 0; i < elementIndex; i++) {
          const element_id = localStorage.getItem(`element_id${i}`);
          const element_nom = document.getElementById(`element_nom_${i}`);
          const coeff_element = document.getElementById(`element_${i}`);
          const coeff_cc = document.getElementById(`element_cc_${i}`);
          const coeff_ecrit = document.getElementById(`element_ecrit_${i}`);
          const coeff_tp = document.getElementById(`element_tp_${i}`);
          const prof_element_select = document.getElementById(`prof_element_${i}`);
          const prof_tp_select = document.getElementById(`prof_tp_${i}`);

          if (!element_nom || !coeff_element || !coeff_cc || !coeff_ecrit || !coeff_tp || !prof_element_select || !prof_tp_select) continue;

          const nomEl = element_nom.value.trim();
          const coeff = parseFloat(coeff_element.value);
          const cc = parseFloat(coeff_cc.value);
          const ecrit = parseFloat(coeff_ecrit.value);
          const tp = parseFloat(coeff_tp.value);
          const profElVal = prof_element_select.value;
          let profTPVal = prof_tp_select.value;
          if (profTPVal === "null") profTPVal = null;

          // Validations
          if (!nomEl) {
            alert(`Le nom de l'élément #${i + 1} est requis.`);
            return;
          }

          if ([cc, ecrit, tp, coeff].some(c => isNaN(c) || c < 0 || c > 1)) {
            alert(`Tous les coefficients de l’élément #${i + 1} doivent être des nombres entre 0 et 1.`);
            return;
          }

          const somme = cc + ecrit + tp;
          if (Math.abs(somme - 1) > 0.0001) {
            alert(`La somme des coefficients (CC + Écrit + TP) de l’élément #${i + 1} doit être exactement égale à 1.`);
            return;
          }

          elementNoms.push({
            id:element_id,
            nom: nomEl,
            coeff_element: coeff,
            coeff_cc: cc,
            coeff_ecrit: ecrit,
            coeff_tp: tp,
            prof_element: profElVal,
            prof_tp: profTPVal
          });

          sommeElement += coeff;
        }

        if (Math.abs(sommeElement - 1) > 0.0001) {
          alert("La somme des coefficients des éléments de module doit être exactement égale à 1.");
          return;
        }

        if (!filiere || !semestre) {
          alert("Veuillez sélectionner la filière et le semestre.");
          return;
        }

        const fullData = {
          module_id:localStorage.getItem("module_id"),
          nomMod: nom,
          codeMod: code,
          filiere: filiere,
          semestre: semestre,
          elements: elementNoms
        };

        fetch('http://localhost:8080/ens-gestion/api/admin2.php?action=ModifierModuleAvecElement', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(fullData)
        })
        .then(response => response.json())
        .then(data => {
          if(data.message === "Module avec éléments modifié"){
            window.location.href = "http://localhost:8080/ens-gestion/app/src/pages/admin/modules.html";
          } else {
            alert("Erreur : " + data.message);
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert("Erreur lors de la modification du module.");
        });

    }
  }
});


  // Supprimer un élément
  window.supprimerElement = function(index) {
    const div = document.getElementById(`element_div_${index}`);
    if (div) {
      div.remove();
    }
  }


  function retourner(){
      window.location.href="http://localhost:8080/ens-gestion/app/src/pages/admin/modules.html";
  }
</script>


</body>
</html>
